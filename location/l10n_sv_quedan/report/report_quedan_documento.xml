<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Bloque: definición de formato de papel para el reporte del Quedán -->
    <record id="paperformat_quedan" model="report.paperformat">
        <field name="name">Quedán - A4</field>
        <field name="format">A4</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">10</field>
        <field name="margin_bottom">10</field>
        <field name="margin_left">10</field>
        <field name="margin_right">10</field>
        <field name="header_line" eval="False"/>
        <field name="header_spacing">0</field>
        <field name="dpi">90</field>
    </record>

    <!-- Acción de reporte (QWeb PDF) para account.quedan -->
    <record id="report_quedan_documento" model="ir.actions.report">
        <field name="name">Quedán de Proveedor</field>
        <field name="model">account.quedan</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">l10n_sv_quedan.report_quedan_documento_template</field>
        <field name="report_file">l10n_sv_quedan.report_quedan_documento_template</field>
        <field name="paperformat_id" ref="l10n_sv_quedan.paperformat_quedan"/>
        <!-- Evitar slash en nombre de archivo generado -->
        <field name="print_report_name">
            'Quedan - %s' % (object.name or 'Quedan').replace('/', '')
        </field>
    </record>

    <!-- Plantilla QWeb del Quedán -->
    <template id="report_quedan_documento_template">
        <t t-name="l10n_sv_quedan.report_quedan_documento_template">
            <t t-name="l10n_sv_quedan.report_quedan_documento_template">
                <t t-name="l10n_sv_quedan.report_quedan_documento_template">
                    <t t-call="web.html_container">
                        <meta charset="UTF-8"/>
                        <t t-foreach="docs" t-as="doc">
                            <style type="text/css">
                                .tg {border-collapse:collapse;border-spacing:0;}
                                .tg td{border-color:transparent;border-style:solid;border-width:1px;font-family:Arial,
                                sans-serif;font-size:14px;
                                overflow:hidden;padding:10px 5px;word-break:normal;}
                                .tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial,
                                sans-serif;font-size:14px;
                                font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
                                .tg .tg-0lax{text-align:left;vertical-align:top;}
                                table {width:100%;}
                                /* Nuevos estilos para definir el ancho de columna */
                                .tg-col-20 { width: 20vw; }
                                .tg-col-60 { width: 60vw; }

                                .signature-cell { text-align: center; }
                                .signature-line { border-top: 1px solid #000; width: 70%; margin: 0 auto 4px auto;
                                height: 0; }
                                .signature-label { margin-top: 2px; }

                                /* Encabezado compacto */
                                .header { width:100%; border-collapse:collapse; table-layout:fixed; }
                                .header col.logo { width:12%; }
                                .header col.title { width:58%; }
                                .header col.meta { width:30%; }

                                .header td { padding:6px 8px; vertical-align:top; }
                                .header-title { margin:0; line-height:1.15; text-align:center; font-size:16px;
                                font-weight:700; }
                                .header-sub { margin:2px 0 0 0; line-height:1.1; text-align:center; font-size:14px;
                                font-weight:700; }

                                .header-meta { line-height:1.15; }
                                .header-meta div { margin:0 0 2px 0; padding:0; }

                                /* que el logo haga ocupar su celda */
                                .header-logo img { max-width:100%; height:auto; display:block; }


                            </style>
                            <div class="page">
                                <table class="header">
                                    <colgroup>
                                        <col class="logo"/>
                                        <col class="title"/>
                                        <col class="meta"/>
                                    </colgroup>
                                    <tr>
                                        <td class="header-logo">
                                            <t t-if="doc.company_id.logo_web">
                                                <img t-att-src="'data:image/png;base64,%s' % doc.company_id.logo_web.decode('utf-8')"/>
                                            </t>
                                        </td>
                                        <td>
                                            <h1 class="header-title">Quedans</h1>
                                            <div class="header-sub">
                                                <t t-esc="doc.company_id.name"/>
                                            </div>
                                        </td>
                                        <td class="header-meta">
                                            <div>
                                                <span>Quedan No.:</span>
                                                <t t-esc="doc.name"/>
                                            </div>
                                            <div>
                                                <span>Fecha:</span>
                                                <t t-esc="doc.fecha_creacion"/>
                                            </div>
                                            <div>
                                                <span>Fecha Pago:</span>
                                                <t t-esc="doc.fecha_programada"/>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                                <div style="margin-top: 2%;  padding: 1%;">
                                    <p style="line-height: 0.5rem;">
                                        <p>Proveedor:


                                            <t t-esc="doc.partner_id.name"/>
                                        </p>
                                    </p>
                                    <p style="line-height: 0.5rem;">
                                        <p>Observaciones:


                                            <t t-esc="doc.observaciones"/>
                                        </p>
                                    </p>
                                </div>
                                <br/>
                                <p>Quedan en nuestro poder para su correspondiente revisión los siguientes documentos:
                                </p>
                                <table style="width:100%; border-collapse:collapse;" border="1">
                                    <thead>
                                        <tr>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Tipo</th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Número</th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Fecha</th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Total</th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Retención
                                                IVA
                                            </th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Percepción
                                            </th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Retención
                                                renta
                                            </th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Impuesto</th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Monto
                                                impuesto
                                            </th>
                                            <th style="border: solid rgba(0,0,0,0.5) 1px; padding: 1% 1%;">Total a
                                                pagar
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Sumas por columna -->
                                        <t t-set="sum_amount_total"
                                           t-value="sum([inv.amount_total or 0.0 for inv in doc.factura_ids])"/>
                                        <t t-set="sum_ret_iva"
                                           t-value="sum([inv.retencion_iva_amount or 0.0 for inv in doc.factura_ids])"/>
                                        <t t-set="sum_percepcion"
                                           t-value="sum([inv.iva_percibido_amount or 0.0 for inv in doc.factura_ids])"/>
                                        <t t-set="sum_ret_renta"
                                           t-value="sum([inv.retencion_renta_amount or 0.0 for inv in doc.factura_ids])"/>
                                        <t t-set="sum_impuesto" t-value="0.0"/>
                                        <t t-set="sum_monto_impuesto" t-value="0.0"/>
                                        <t t-set="sum_total_pagar"
                                           t-value="sum([inv.total_pagar or 0.0 for inv in doc.factura_ids])"/>
                                        <!-- Detalle -->
                                        <t t-foreach="doc.factura_ids" t-as="invoice">
                                            <tr>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.journal_id.code"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.hacienda_codigoGeneracion_identificacion"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.invoice_date"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.amount_total"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.retencion_iva_amount"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.iva_percibido_amount"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.retencion_renta_amount"/>
                                                </td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">0</td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">0.00</td>
                                                <td style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%;">
                                                    <t t-esc="invoice.total_pagar"/>
                                                </td>
                                            </tr>
                                        </t>
                                        <!-- Fila de totales -->
                                        <tr>
                                            <td class="tg-0lax" colspan="3"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700; text-align:right;">
                                                Totales:
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_amount_total"/>
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_ret_iva"/>
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_percepcion"/>
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_ret_renta"/>
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_impuesto"/>
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_monto_impuesto"/>
                                            </td>
                                            <td class="tg-0lax"
                                                style="border:1px solid rgba(0,0,0,0.5); padding:1% 1%; font-weight:700;">
                                                <t t-esc="sum_total_pagar"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <p style="margin-top: 5%;">
                                <strong style="font-size: 14px;">Nota:</strong>
                            </p>
                            <table style="width:100%; margin-top: 8px;">
                                <tr>
                                    <td style="width:50%; vertical-align:top;">
                                        <p>Elaborado por:


                                            <t t-esc="doc.create_uid.name or ''"/>
                                        </p>
                                    </td>
                                    <td class="signature-cell" style="width:50%; vertical-align:bottom;">
                                        <div class="signature-line"/>
                                        <div class="signature-label">Autorizado</div>
                                    </td>
                                </tr>
                            </table>
                        </t>
                    </t>
                </t>
            </t>
        </t>
    </template>
</odoo>
